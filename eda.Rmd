---
title: "eda"
author: "Team Infinite Limits"
date: "October 29, 2017"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(rpart)
library(DMwR2)
library(randomForest)
library(rpart.plot)
source("label_data.R")
knitr::opts_chunk$set(echo = TRUE)

set.seed(123)
train_sample<-sample.int(nrow(health),size=round(.6*nrow(health)))
inds=1:nrow(health)

health_test<-health[inds[-train_sample],]
health<-health[inds[train_sample],]

```

```{r echo=TRUE}

health %>%
  ggplot(aes(x=FAMRACEW1)) +
  geom_bar(aes(group=1,y=..prop..)) +
  coord_flip()

```


```{r echo=TRUE}

health %>%
  ggplot(aes(x=CGRADEW1)) +
  geom_bar()

```

```{r echo=TRUE}
health %>%
  filter(!is.na(CSEXW1)) %>%
  ggplot() +
  geom_density(aes(x=CGPATOTW1),na.rm=TRUE) +
  facet_wrap(~CSEXW1,drop=TRUE)
```


```{r echo=FALSE}
set.seed(123)
rh <- health %>%
  select(-CGPASTEMW1,-BIRTHYR) %>%
  filter(!is.na(CGPATOTW1))

rf_model<-rpartXse(CGPATOTW1 ~ ., data=rh)

prp(rf_model)
```

```{r echo=TRUE}
health %>%
  mutate_all(is.na) %>%
  summarise_all(sum) %>%
  gather(key="varname",value="sumnas") %>%
  arrange(desc(sumnas))
```

```{r echo=TRUE}
rhs <- health %>%
  select(
  DLYACT1W1,
  PHYSXMW1,
  DENTXMW1,
  BARMEDCR,
  H1GH53,
  RELIGIONW1,
  IMPRELW1,
  YRSSCHLW1,
  TWINW1,
  TWNSMHSW1,
  BIOPLVWT,
  CLUBACADW1,
  CLUBMUARTW1,
  CLUBSPORTW1,
  CRPWBW1,
  CSCLBELNGW1,
  SOCSPPTW1,
  POSFMENVW1,
  CATONMYW1,
  COLEXPW1,
  NGHSOCCAPW1,
  MWARMTHW1,
  DWARMTHW1,
  MPOSRELW1,
  CGPATOTW1
  )
set.seed(927)
tree_mod <- rpartXse(CRPWBW1 ~ ., rhs)
prp(tree_mod)
```

```{r echo=TRUE}
rhs_dropped <- na.omit(rhs)
rhs_dropped <- rhs %>%
  mutate_if(is.factor,droplevels) %>%
  select_if(function(x) length(unique(x))>1)

mod <- lm (CGPATOTW1 ~ SOCSPPTW1, data=rhs_dropped, na.action=na.omit)
```

```{r echo=TRUE}
qqnorm(log(health$DEPREW1[health$DEPREW1>0]))
```

Depression in students

```{r echo=TRUE}

```

```{r echo=TRUE}

health$DLYACTAVG <- health %>%
  transmute_at(vars(starts_with("DLYACT")), as.numeric) %>%
  apply(1,function(x) mean(x, na.rm=TRUE))
health$CLUBAVG <- health %>%
  transmute_at(vars(starts_with("CLUB")), as.numeric) %>%
  apply(1,function(x) mean(x, na.rm=TRUE))

predictors <- unique(c("INTELLW1" , "MFUTEXPW1" , "DFUTEXPW1", "CGPATOTW1",
                  "NEGLFEXPW1", "POSLFEXPW1" , "SELFESTW1" , "MENTHFREW1" , "WLUNHLTHW1" ,
                  "DLYACTAVG", "BODYIMGW1" , "MOMEDW1" , "MOMWKW1" , "DADWKW1" , 
                  "IMPRELW1" ,"CLUBAVG" , "SOCSPPTW1" , 
                  "POSFMENVW1", "BIO_SEX", "SLEEP","SCLBELNG2W1","SCHLTRBLW1","CPRBEHLMW1",
                  "SCHEXPEL","PHYHFREQW1",))


health_rmna <- na.omit(health[,c("DEPREW1",predictors)])
health_rmna <-droplevels.data.frame(health_rmna)
health_rmna <- health_rmna %>%
  filter(DEPREW1 > 0.0001) %>%
  mutate(DEPREW1 = log(DEPREW1))

```

```{r echo=TRUE}

health_rmna <- health_rmna[c(-337,-382,-172,-916),]

form<-as.formula(paste("DEPREW1 ~ ", paste(c(predictors,"BODYIMGW1*BIO_SEX"),collapse="+")))

intel_mod <- lm(as.formula(paste("DEPREW1 ~ ", paste(c(predictors,"BODYIMGW1*BIO_SEX"),collapse="+"))),
                data=health_rmna, na.action=na.omit)

intel_mod_both<-step(intel_mod,trace=0)

summary(intel_mod2)
```


```{r message=FALSE, warning=FALSE, include=FALSE}

multiplot <- function(..., plotlist=NULL, cols) {
    require(grid)

    # Make a list from the ... arguments and plotlist
    plots <- c(list(...), plotlist)

    numPlots = length(plots)

    # Make the panel
    plotCols = cols                          # Number of columns of plots
    plotRows = ceiling(numPlots/plotCols) # Number of rows needed, calculated from # of cols

    # Set up the page
    grid.newpage()
    pushViewport(viewport(layout = grid.layout(plotRows, plotCols)))
    vplayout <- function(x, y)
        viewport(layout.pos.row = x, layout.pos.col = y)

    # Make each plot, in the correct location
    for (i in 1:numPlots) {
        curRow = ceiling(i/plotCols)
        curCol = (i-1) %% plotCols + 1
        print(plots[[i]], vp = vplayout(curRow, curCol ))
    }

}

graphs = list()

for(i in 1:length(names(intel_mod2$model))) {
  var_name=names(intel_mod2$model)[i]
  temp <- as.tibble(cbind(X=intel_mod2$model[[var_name]],Y=intel_mod2$residuals))
  g <- ggplot(data=temp) +
    geom_point(aes(x=X,y=Y)) 
  graphs[[i]]<-g
}


```

```{r echo=TRUE}

as.tibble(cbind(CGPATOTW1=intel_mod2$model$CGPATOTW1,residuals=intel_mod$residuals)) %>%
  ggplot() + 
  geom_point(aes(x=CGPATOTW1,y=residuals))

```
```{r echo=TRUE}
as.tibble(cbind(NEGLFEXPW1=intel_mod2$model$NEGLFEXPW1,residuals=intel_mod$residuals)) %>%
  ggplot() + 
  geom_point(aes(x=NEGLFEXPW1,y=residuals))
```
```{r echo=TRUE}
as.tibble(cbind(SELFESTW1=intel_mod2$model$SELFESTW1,residuals=intel_mod$residuals)) %>%
  ggplot() + 
  geom_point(aes(x=SELFESTW1,y=residuals))
```
```{r echo=TRUE}
as.tibble(cbind(MENTHFREW1=intel_mod2$model$MENTHFREW1,residuals=intel_mod$residuals)) %>%
  ggplot() + 
  geom_point(aes(x=MENTHFREW1,y=residuals))
```

```{r echo=TRUE}
as.tibble(cbind(MENTHFREW1=intel_mod2$model$MENTHFREW1,residuals=intel_mod$residuals)) %>%
  ggplot() + 
  geom_point(aes(x=MENTHFREW1,y=residuals))
```

```{r echo=TRUE}
as.tibble(cbind(WLUNHLTHW1=intel_mod2$model$WLUNHLTHW1,residuals=intel_mod$residuals)) %>%
  ggplot() + 
  geom_point(aes(x=WLUNHLTHW1,y=residuals))
```

```{r echo=TRUE}

set.seed(927)
rf_mod <- randomForest(form, data=health_rmna)

importance(rf_mod)
```
